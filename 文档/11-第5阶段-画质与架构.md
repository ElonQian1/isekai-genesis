# 第5阶段：画质升级与长期主义架构

> **目标**：实现《神界：原罪2》级别的俯视角画面，并建立可支撑庞大内容的长期主义代码架构。

---

## 1. 核心问题解答

### Q1: 我需要额外下载素材吗？
**A: 必须需要。**
代码可以生成“结构”（如地形起伏、随机分布），但无法生成“高精度细节”（如岩石的裂纹、树皮的质感、复杂的建筑雕花）。
要达到 3A 级画质，我们需要引入 **PBR (基于物理的渲染)** 工作流：
*   **模型 (Models)**: `.glb` / `.gltf` 格式的高精度模型（树木、建筑、角色）。
*   **材质 (Textures)**: 包含 漫反射(Albedo)、法线(Normal)、粗糙度(Roughness)、金属度(Metallic)、环境光遮蔽(AO) 的贴图组。
*   **环境 (Environment)**: HDR 环境贴图，用于提供真实的反射和光照。

### Q2: 代码文件会越来越大，如何避免？
**A: 采用“数据驱动 (Data-Driven)”架构。**
目前我们的代码里有很多 `new ClTree(...)` 或 `for` 循环生成物体的逻辑。随着游戏内容增加，这些代码会爆炸。
**解决方案**：
1.  **逻辑与数据分离**：代码只写“规则”（如何加载树），数据写“内容”（树在哪里）。
2.  **配置化**：使用 JSON 文件定义地图内容、物品属性、怪物分布。
3.  **模块化加载**：不要一次性加载所有代码，按需加载子系统。

---

## 2. 长期主义架构规划

### 2.1 目录结构优化
```
client/src/
├── assets/                 # 资源定义 (非原始文件，而是加载配置)
│   ├── manifests/          # 资源清单 (JSON)
│   └── definitions/        # 物品/怪物定义 (JSON/TS)
├── core/                   # 核心引擎层 (与具体玩法无关)
│   ├── event_bus.ts        # 全局事件总线
│   └── service_locator.ts  # 服务定位器 (解耦依赖)
├── modules/                # 业务模块 (按功能划分)
│   ├── combat/             # 战斗模块
│   ├── inventory/          # 背包模块
│   └── world/              # 大世界模块
└── render/                 # 渲染层
    ├── materials/          # PBR 材质库
    └── pipelines/          # 渲染管线 (后处理、阴影)
```

### 2.2 数据驱动示例
**旧代码 (Hardcoded):**
```typescript
// cl_world_scene.ts
for(let i=0; i<10; i++) {
    const tree = new ClTree(scene);
    tree.position = new Vector3(Math.random()*100, 0, Math.random()*100);
}
```

**新架构 (Data-Driven):**
```typescript
// map_data_forest.json
{
    "entities": [
        { "type": "tree_pine_01", "pos": [10, 0, 20], "scale": 1.2 },
        { "type": "rock_moss_02", "pos": [15, 0, 25], "rot": [0, 45, 0] }
    ]
}

// 代码只负责解析
class ClLevelLoader {
    loadMap(data: MapData) {
        data.entities.forEach(entity => {
            this.spawner.spawn(entity.type, entity.pos);
        });
    }
}
```
**优势**：无论地图有一棵树还是一万棵树，代码行数不变。

---

## 3. 画质升级路线 (PBR & Graphics)

### 3.1 材质系统升级
*   废弃 `StandardMaterial` (传统光照)。
*   全面启用 `PBRMaterial` (物理光照)。
*   引入 **ClMaterialManager**，统一管理 PBR 材质预设。

### 3.2 光照与后处理
*   **IBL (Image Based Lighting)**: 使用 HDR 贴图照亮场景，这是真实感的关键。
*   **Shadows**: 级联阴影贴图 (CSM) 用于大场景阴影。
*   **Post-Processing**:
    *   **SSAO**: 屏幕空间环境光遮蔽 (增加角落阴影细节)。
    *   **Bloom**: 辉光 (让亮部发光)。
    *   **Tone Mapping**: 色调映射 (电影感色彩)。

---

## 4. 下一步行动计划

1.  **建立资源库**：
    *   在 `public/assets` 下建立规范的目录结构。
    *   下载/制作第一批 PBR 材质 (草地、岩石、木纹)。
2.  **重构材质库**：
    *   修改 `ClMaterialLibrary`，支持 PBR 材质创建。
3.  **实现数据加载器**：
    *   创建 `ClLevelLoader`，尝试从 JSON 加载场景物体。
4.  **光照升级**：
    *   引入 HDR 环境光，调整太阳光参数。

此架构将确保项目在扩展到庞大世界时，代码依然清晰、可维护。

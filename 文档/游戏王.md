User: 我这个项目想手机端打开，手机端竖屏打开，

战斗的时候， 一个手机屏幕大小的 战场沙盘，分南北地形。

北边是敌人，南边是自己。 不同的地形会对玩家的卡牌有不同的加成，玩家卡牌可能召唤出怪兽，这些怪兽会因为地形场景而获得buff /debuff

在现在的基础上如何修改？ 手机端，PC端 如何修改？ 可不可行，当前的代码架构？ 能否实现我这个愿望？

GitHub Copilot: 研究项目架构和可行性

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/main.ts)

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/cl_scene_manager_v2.ts#1-1)，行 1 到 150

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/cl_battle_manager.ts#1-1)，行 1 到 150

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/cl_battle_controller.ts#1-1)，行 1 到 150

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/%E6%96%87%E6%A1%A3/00-%E9%A1%B9%E7%9B%AE%E6%80%BB%E8%A7%88.md)

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render)

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/scenes)

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/ui)

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/crates/game-core/src)

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/%E6%96%87%E6%A1%A3/04-client.md#1-1)，行 1 到 150

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/%E6%96%87%E6%A1%A3/09-%E6%A8%A1%E5%9D%97%E5%8C%96%E6%9E%B6%E6%9E%84.md#1-1)，行 1 到 150

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/crates/game-core/src/gc_battlefield.rs#1-1)，行 1 到 150

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/crates/game-core/src/gc_effect.rs#1-1)，行 1 到 150

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/crates/game-core/src/gc_card.rs#1-1)，行 1 到 150

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/cl_battle_scene.ts#1-1)，行 1 到 100

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/ui/cl_battlefield_ui.ts#1-1)，行 1 到 100

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/cl_game.ts#1-1)，行 1 到 100

搜索正则表达式 `terrain|地形|Terrain`，20 个结果

搜索正则表达式 `mobile|responsive|移动端|竖屏|portrait`，3 个结果

搜索正则表达式 `buff|debuff|状态效果`，20 个结果

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/world)

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/battle)

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/world/terrain/cl_terrain_manager.ts#1-1)，行 1 到 100

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/battle/cl_battle_field.ts#1-1)，行 1 到 100

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/crates/game-core/src/gc_effect.rs#130-130)，行 130 到 200

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/scenes/cl_battle_scene_controller.ts#1-1)，行 1 到 100

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/world/terrain)

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/ui/cl_battle_ui.ts#1-1)，行 1 到 100

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/battle/cl_battle_scene.ts#1-1)，行 1 到 200

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/index.html)

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/crates/game-core/src/gc_effect.rs#200-200)，行 200 到 250

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/crates/game-core/src/lib.rs#1-1)，行 1 到 50

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/battle/cl_battle_types.ts#1-1)，行 1 到 100

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/cl_scene_manager_v2.ts#100-100)，行 100 到 150

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/%E6%96%87%E6%A1%A3/%E6%8F%90%E7%A4%BA%E8%AF%8D2.md)

## Plan: 手机竖屏战场沙盘系统实现

基于当前 Babylon.js + Rust WASM 架构，实现手机端竖屏战斗模式、南北地形战场沙盘、地形 Buff/Debuff 系统是**完全可行的**。现有架构模块化良好，已有基础战斗系统和 Buff/Debuff 类型定义，主要需要新增地形模块、扩展战场布局、并添加响应式 UI 适配。

---

### 步骤

1. **响应式适配层** — 在 index.html 添加屏幕方向锁定，在 cl_game.ts 添加竖屏/横屏检测，动态调整相机角度和 UI 布局比例

2. **战场南北分区** — 修改 cl_battle_scene_controller.ts，将现有 6 格网格重构为南（己方 5 槽）/ 北（敌方 5 槽）分区布局，添加分界线可视化

3. **Rust 地形模块** — 在 src 新建 `gc_battle_terrain.rs`，定义地形枚举（平原/森林/水域/山地/沼泽）和对应 Buff/Debuff 效果，扩展 gc_battlefield.rs 添加南北地形属性

4. **地形效果逻辑** — 在 gc_effects.rs 添加地形触发的 Buff/Debuff 计算逻辑，并通过 game-wasm 导出给前端

5. **前端地形渲染** — 新建 `client/src/render/battle/cl_terrain_renderer.ts`，根据地形类型应用不同材质/颜色，在 cl_battle_ui.ts 添加 Buff/Debuff 状态图标显示

6. **怪兽召唤系统**（可选后续阶段）— 在 `game-core` 新建 `gc_monster.rs` 定义怪兽实体，前端新建 `cl_monster_renderer.ts` 实现 3D 模型加载和地形联动效果

---

### 进一步考虑

1. **PC 端兼容策略** — 推荐检测屏幕宽高比自动切换布局（竖屏用南北布局，横屏用左右布局），还是强制统一为南北布局？

2. **地形随机性** — 每场战斗的地形是固定的、随机生成的、还是由关卡/地图决定？这影响核心架构设计

3. **怪兽模型资源** — 当前 素材包 中只有环境素材，怪兽 3D 模型需要另外准备，是否有计划的模型来源？

User: 现在遇到怪物 是一种什么样的场景打开战斗画面？

如何做到：
战斗场景打开以后， 
是一个双方的战斗沙盘， 对手在上方，我方在屏幕下方，
玩家在 自己地形领域部署卡牌，不同的地形会对玩家的卡牌有不同的加成，玩家卡牌可能召唤出怪兽，这些怪兽会因为地形场景而获得buff /debuff


GitHub Copilot: 研究战斗场景触发机制

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/cl_scene_manager_v2.ts#1-1)，行 1 到 200

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/scenes/cl_battle_scene_controller.ts#1-1)，行 1 到 200

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/ui/cl_battle_ui.ts#1-1)，行 1 到 200

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/ui/cl_battlefield_ui.ts#1-1)，行 1 到 200

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/cl_scene_manager_v2.ts#200-200)，行 200 到 450

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/battle/cl_battle_scene.ts#1-1)，行 1 到 250

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/scenes/cl_world_scene_controller.ts#1-1)，行 1 到 200

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/battle/cl_battle_scene.ts#250-250)，行 250 到 500

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/world/entities/cl_enemy_system.ts#1-1)，行 1 到 150

搜索正则表达式 `battlefield|战场` (`**/crates/game-core/**/*.rs`)，20 个结果

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/crates/game-core/src/gc_battlefield.rs#1-1)，行 1 到 150

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/cl_scene_manager_v2.ts#450-450)，行 450 到 700

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/battle/cl_battle_scene.ts#500-500)，行 500 到 750

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/crates/game-core/src/gc_battlefield.rs#150-150)，行 150 到 300

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/ui/cl_battlefield_ui.ts#200-200)，行 200 到 395

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/scenes/cl_battle_scene_controller.ts#200-200)，行 200 到 438

搜索正则表达式 `terrain|地形`，20 个结果

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/battle)

搜索与 `**/cl_world_scene*.ts` 匹配的文件，2 匹配项

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/battle/cl_battle_field.ts#1-1)，行 1 到 100

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/cl_battle_scene.ts#1-1)，行 1 到 100

读取 [](file:///d%3A/%E6%B5%8B%E8%AF%95%E5%8D%A1%E7%89%8C%E6%B8%B8%E6%88%8F/client/src/render/battle/index.ts)

## Plan: 战斗沙盘南北地形系统

当前战斗触发流程已完整实现：玩家在大世界遇到敌人 → 碰撞检测触发 → 延迟1秒切换到战斗场景。现有战斗场景是简单的 3x2 格子 + 5槽位系统，**没有南北区分和地形概念**。需要重构战斗场景为双方对战沙盘布局，并新增地形 Buff/Debuff 系统。

---

### 步骤

1. **Rust 核心: 地形类型定义** — 在 src 新建 `gc_battle_terrain.rs`，定义 `GcTerrainType` 枚举（草地/火山/冰原/水域/沼泽）和每种地形对应的 Buff/Debuff 效果列表

2. **Rust 核心: 战场扩展** — 修改 gc_battlefield.rs，添加 `player_terrain: GcTerrainType` 和 `enemy_terrain: GcTerrainType` 字段，以及南北双方各自的部署槽位

3. **WASM 接口导出** — 在 game-wasm/src/lib.rs 新增 `get_terrain_buffs(terrain_type)` 和 `apply_terrain_effect(card_id, terrain_type)` 等接口供前端调用

4. **3D 战场重构** — 重写 cl_battle_scene.ts 的 `createBattleGrid()`，将 3x2 格子扩展为南北双区域（各 2x3=6 格），添加中线分隔可视化，敌方格子在屏幕上方(+Z)、我方在下方(-Z)

5. **地形渲染系统** — 新建 `client/src/render/battle/cl_battle_terrain.ts`，根据地形类型为南北区域应用不同材质/颜色（草地=绿、火山=红、冰原=蓝、水域=青）

6. **UI 布局适配** — 修改 cl_battlefield_ui.ts，将敌方槽位显示在上方 (`topOffset = -200px`)、我方在下方 (`topOffset = +200px`)，添加地形类型图标和 Buff/Debuff 状态显示

7. **战斗逻辑集成** — 修改 cl_battle_manager.ts，在卡牌部署时调用 WASM 计算地形加成，将 Buff/Debuff 应用到召唤的怪兽/卡牌效果上

---

### 进一步考虑

1. **地形决定方式** — 每场战斗的南北地形是随机生成、由遭遇敌人类型决定、还是由大世界当前位置的地形自动继承？

2. **怪兽实体系统** — 当前卡牌直接造成伤害，若要实现"召唤怪兽站在格子上"，需要新建 `GcMonster` 实体类型和对应的 3D 模型渲染器，这是否为第一阶段目标？

3. **竖屏相机角度** — 手机竖屏时相机需要更高更远 (`Y=18, Z=-12`) 以容纳南北完整战场，是否需要同时支持横屏的左右布局？

User: PC 端 为了体现部署战斗的宏观性， 我希望整个双方战斗/部署的沙盘是可以360度旋转 来观摩整个战斗的。

手机性能比较差，所以我计划手机就只是固定的南北/上下部署卡牌/怪兽，
玩法类似《游戏王》

怪兽模型资源 ，目前还没有，将来会不断增加怪兽设计的资源。每个版本都会推出新的角色



GitHub Copilot: ## Plan: 双端战斗沙盘系统（PC 360°旋转 + 手机固定视角）

基于《游戏王》式玩法，实现 PC 端可 360° 旋转观战的宏观沙盘、手机端固定俯视南北布局。架构需支持怪兽模型动态加载，便于未来版本持续扩展新角色。当前 Babylon.js + Rust WASM 架构完全支持此设计。

---

### 步骤

1. **设备检测与相机策略** — 在 cl_game.ts 添加设备类型检测（PC/Mobile），PC 端使用 `ArcRotateCamera` 支持 360° 旋转拖拽，手机端使用固定 `UniversalCamera` 锁定俯视角度

2. **战场沙盘 3D 布局** — 重构 cl_battle_scene.ts，创建游戏王式双区域战场：敌方区域（北，+Z）含怪兽区 5 格 + 魔法陷阱区 5 格，我方区域（南，-Z）同样布局，中央添加分界线网格

3. **Rust 核心: 战场槽位系统** — 扩展 gc_battlefield.rs，定义 `GcSlotType`（怪兽区/魔陷区）、南北双方各 10 槽位、地形类型字段，以及槽位状态（空/已占用/卡牌ID）

4. **怪兽模型动态加载架构** — 新建 `client/src/render/battle/cl_monster_loader.ts`，实现按需加载模型系统：定义 `MonsterRegistry` 注册表，支持从 `assets/monsters/{id}/` 加载 glTF 模型，未找到时显示默认占位符（彩色胶囊体）

5. **地形 Buff/Debuff 系统** — 在 src 新建 `gc_battle_terrain.rs`，定义地形枚举和效果映射表，通过 game-wasm 导出 `calculate_terrain_buff(monster_id, terrain_type)` 接口

6. **UI 双端适配** — 修改 cl_battlefield_ui.ts，PC 端显示完整 10 槽位 UI + 旋转提示，手机端简化为上下紧凑布局 + 大触控按钮，添加卡牌/怪兽状态面板显示 Buff/Debuff 图标

7. **怪兽资源扩展规范** — 新建 `assets/monsters/README.md`，定义怪兽资源目录结构（`{id}/model.glb`、`{id}/icon.png`、`{id}/config.json`），便于未来版本添加新角色时遵循统一规范

---

### 进一步考虑

1. **PC 旋转限制** — 360° 旋转时是否允许相机穿到地下？建议限制仰角范围（10°~80°），你是否同意？

2. **游戏王式规则深度** — 是否需要完整的召唤规则（普通召唤/特殊召唤/祭品召唤）？还是简化为"卡牌放置→怪兽出现"即可？

3. **怪兽占位符设计** — 在没有 3D 模型时，临时显示彩色几何体（胶囊/立方体）+ 怪兽名称文字，还是显示 2D 卡牌立牌？哪种更符合你的视觉预期？

User: 地形决定方式 — 每场战斗的南北地形是随机生成、也由遭遇敌人类型决定、

大世界当前位置的地形也影响形成概率，

有直接造成伤害的卡牌系统，也有怪兽实体系统pk系统。

竖屏相机角度 是我临时决定的，我不知道 支持横屏的左右布局 是否更好。

GitHub Copilot: ## Plan: 完整战斗沙盘系统（地形+双战斗模式+双端适配）

整合地形概率生成、直接伤害卡牌 + 怪兽 PK 双系统、PC 360° 旋转 + 手机固定视角。地形由大世界位置 + 敌人类型 + 随机因子共同决定。建议手机端**同时支持横竖屏**，竖屏用南北布局、横屏用左右布局，让玩家自选。

---

### 步骤

1. **Rust 核心: 地形生成系统** — 新建 `crates/game-core/src/gc_battle_terrain.rs`，定义 `GcTerrainType` 枚举，实现 `generate_terrain(world_pos, enemy_type, rng_seed)` 函数：大世界地形提供基础概率权重，敌人类型修正概率，最终随机抽取

2. **Rust 核心: 双战斗模式** — 扩展 gc_battlefield.rs，定义 `GcBattleAction` 枚举（`DirectDamage` 直接伤害 / `SummonMonster` 召唤怪兽 / `MonsterAttack` 怪兽攻击），怪兽实体 `GcMonster` 包含 HP/ATK/DEF/位置/Buff 列表

3. **Rust 核心: Buff/Debuff 计算** — 在 `gc_battle_terrain.rs` 添加 `apply_terrain_effect(monster, terrain)`，根据地形类型和怪兽属性计算加成（如火属性怪兽在火山地形 ATK+20%，在水域 ATK-10%）

4. **WASM 接口层** — 在 game-wasm/src/lib.rs 导出：`generate_battle_terrain()`、`play_direct_damage_card()`、`summon_monster()`、`monster_attack()`、`get_terrain_buffs()`

5. **设备检测与相机系统** — 修改 cl_game.ts，检测设备和屏幕方向，PC 用 `ArcRotateCamera`（仰角限制 10°~80°），手机竖屏用固定俯视相机，手机横屏用固定侧视相机，监听 `orientationchange` 事件动态切换

6. **战场 3D 布局** — 重构 cl_battle_scene.ts，创建 5+5 槽位双区域（怪兽区 5 格 + 可扩展），根据地形类型应用不同材质，怪兽槽位显示 3D 模型或占位立牌

7. **怪兽动态加载器** — 新建 `client/src/render/battle/cl_monster_loader.ts`，实现 `loadMonster(id): Promise<Mesh>`，优先加载 `assets/monsters/{id}/model.glb`，无模型时生成带名称文字的 2D 卡牌立牌作为占位

8. **响应式 UI 布局** — 修改 cl_battlefield_ui.ts，竖屏时敌方在上/我方在下，横屏时敌方在左/我方在右，卡牌池始终在屏幕底部/右侧，添加怪兽状态面板显示 HP 条和 Buff 图标

9. **战斗流程控制** — 修改 cl_battle_manager.ts，支持混合回合：玩家可选择打出直接伤害卡牌或召唤怪兽，怪兽每回合自动攻击对方怪兽或直接攻击玩家

---

### 进一步考虑

1. **怪兽 vs 怪兽规则** — 当双方都有怪兽时，是自动互相攻击（类似游戏王战斗阶段），还是玩家手动指定攻击目标？

2. **占位立牌样式** — 无 3D 模型时显示 2D 卡牌立牌（卡面图 + 名称 + ATK/DEF 数值），这个方案你是否满意？还是更偏好简单几何体？

3. **地形可视化程度** — 地形效果是仅用颜色/材质区分，还是需要添加粒子特效（火山冒烟、水域波纹、冰原飘雪）？特效会增加手机端性能负担

User: 360° 旋转时允许相机穿到地下
需要完整的召唤规则（普通召唤/特殊召唤/祭品召唤）
临时显示彩色几何体（胶囊/立方体）+ 怪兽名称文字，

怪兽 vs 怪兽规则  玩家在特殊情况下可以 手动指定攻击目标，默认是自动攻击

地形可视化程度 只要能区分出地形就可以了。当然能扩展支持越多细节越好， 用户设备性能允许的话。可以都开启

GitHub Copilot: ## Plan: 完整战斗沙盘系统（终版）

整合所有确认需求：PC 360° 自由旋转（可穿地）、完整召唤规则系统、临时几何体怪兽、自动攻击 + 手动指定、地形基础可视化 + 可选特效扩展。分阶段实施，优先核心功能。

---

### 步骤

1. **Rust 核心: 地形系统** — 新建 `crates/game-core/src/gc_battle_terrain.rs`
   - 定义 `GcTerrainType`（草地/火山/冰原/水域/沼泽/暗域）
   - 实现 `generate_terrain(world_terrain, enemy_type, seed)` 概率生成
   - 定义地形→Buff/Debuff 映射表，导出 `get_terrain_modifiers()`

2. **Rust 核心: 怪兽实体** — 新建 `crates/game-core/src/gc_monster.rs`
   - 定义 `GcMonster { id, name, hp, atk, def, level, attribute, position, buffs }`
   - 定义 `GcMonsterAttribute`（火/水/风/地/光/暗）用于地形亲和计算
   - 实现 `apply_terrain_buff(monster, terrain)` 计算最终属性

3. **Rust 核心: 召唤规则系统** — 新建 `crates/game-core/src/gc_summon.rs`
   - 定义 `GcSummonType`（Normal 普通 / Special 特殊 / Tribute 祭品）
   - 普通召唤: 每回合 1 次，4 星以下直接召唤
   - 祭品召唤: 5-6 星需 1 祭品，7+ 星需 2 祭品
   - 特殊召唤: 卡牌效果触发，不占普通召唤次数
   - 实现 `validate_summon(card, field_state, summon_type): Result<(), SummonError>`

4. **Rust 核心: 战斗行动系统** — 扩展 gc_battlefield.rs
   - 定义 `GcBattleAction`（DirectDamage / SummonMonster / MonsterAttack / SetTrap）
   - 怪兽攻击: `attack(attacker_slot, target_slot: Option<u8>)`，None 时自动选目标
   - 自动攻击逻辑: 攻击对方 ATK 最低的怪兽，无怪兽则直接攻击玩家
   - 战斗伤害计算: `damage = attacker.atk - target.def`（考虑地形加成）

5. **WASM 接口导出** — 扩展 game-wasm/src/lib.rs
   - `generate_battle_terrain(world_x, world_z, enemy_id)`
   - `normal_summon(card_id, slot)` / `tribute_summon(card_id, slot, tribute_slots[])`
   - `monster_attack(attacker_slot, target_slot?)` / `play_spell_card(card_id, target?)`
   - `get_field_state()` 返回完整战场 JSON

6. **设备检测与相机** — 修改 cl_game.ts
   - PC: `ArcRotateCamera`，alpha/beta 无限制（允许穿地），滚轮缩放
   - 手机竖屏: 固定俯视 `UniversalCamera(0, 15, -8)`
   - 手机横屏: 固定侧视 `UniversalCamera(-12, 8, 0)`
   - 监听 `resize` + `orientationchange` 动态切换布局

7. **战场 3D 渲染** — 重构 cl_battle_scene.ts
   - 创建南北双区域各 5 怪兽格 + 5 魔陷格（共 20 格）
   - 地形材质: 草地=绿色 / 火山=红橙 / 冰原=浅蓝 / 水域=深蓝 / 沼泽=棕绿
   - 中央分界线用发光线条标识
   - 可选特效层: 检测 GPU 性能，高端设备启用粒子（火焰/雪花/水波）

8. **怪兽占位渲染** — 新建 `client/src/render/battle/cl_monster_renderer.ts`
   - 无模型时生成彩色几何体: 根据属性选色（火=红胶囊 / 水=蓝立方体 / 风=绿圆锥...）
   - 头顶显示动态文字: 怪兽名称 + ATK/DEF 数值
   - 未来支持: `loadModel(monster_id)` 从 `assets/monsters/` 加载 glTF 替换占位

9. **响应式战斗 UI** — 修改 cl_battlefield_ui.ts
   - 竖屏: 敌方槽位在上 / 我方在下 / 卡牌池底部
   - 横屏: 敌方在左 / 我方在右 / 卡牌池右侧
   - 添加召唤类型选择菜单（普通/祭品/特殊）
   - 攻击时显示目标选择 UI（点击敌方怪兽或"直接攻击"按钮）

10. **战斗流程控制** — 修改 cl_battle_manager.ts
    - 回合阶段: 抽牌→主阶段1→战斗阶段→主阶段2→结束
    - 战斗阶段: 遍历己方怪兽，默认自动攻击，玩家可中断手动指定
    - 祭品召唤 UI: 选择场上怪兽作为祭品→确认→召唤

---

### 架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                      client/ (TypeScript)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ cl_game.ts   │  │ battle_scene │  │ monster_     │      │
│  │ 设备检测     │  │ 3D战场渲染   │  │ renderer     │      │
│  │ 相机切换     │  │ 地形材质     │  │ 占位几何体   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │ battlefield  │  │ battle_      │  ←── 调用 WASM         │
│  │ _ui.ts       │  │ manager.ts   │                        │
│  │ 响应式布局   │  │ 回合流程     │                        │
│  └──────────────┘  └──────────────┘                        │
└─────────────────────────────────────────────────────────────┘
                            │ wasm-bindgen
┌─────────────────────────────────────────────────────────────┐
│                    game-wasm/ (Rust→WASM)                   │
│        导出: summon / attack / terrain / field_state       │
└─────────────────────────────────────────────────────────────┘
                            │ 共享
┌─────────────────────────────────────────────────────────────┐
│                      game-core/ (Rust)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ gc_battle_   │  │ gc_monster   │  │ gc_summon    │      │
│  │ terrain.rs   │  │ .rs          │  │ .rs          │      │
│  │ 地形生成     │  │ 怪兽实体     │  │ 召唤规则     │      │
│  │ Buff计算     │  │ 属性亲和     │  │ 祭品验证     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐                                          │
│  │ gc_battle    │                                          │
│  │ field.rs     │  ← 扩展战斗行动、自动/手动攻击           │
│  └──────────────┘                                          │
└─────────────────────────────────────────────────────────────┘
```

---

### 实施阶段建议

| 阶段 | 内容 | 工期 |
|------|------|------|
| **P1** | 地形系统 + 战场南北布局 + 基础材质 | 2-3天 |
| **P2** | 怪兽实体 + 占位几何体渲染 + 召唤系统 | 3-4天 |
| **P3** | 战斗流程（自动攻击 + 手动指定） | 2-3天 |
| **P4** | 双端适配（PC 360° + 手机横竖屏） | 2天 |
| **P5** | 可选地形特效 + 性能检测开关 | 1-2天 |

---

### 进一步考虑

1. **祭品召唤 UI 交互** — 祭品选择是拖拽怪兽到祭坛，还是点击选中后确认？推荐点击选中更适合触屏

2. **特殊召唤触发时机** — 是否需要实现"连锁"系统（对方行动时可以响应）？这会显著增加复杂度，建议初版简化为仅己方回合触发

3. **存档兼容** — 新增怪兽/地形系统后，旧存档如何处理？建议在 `game-core` 添加版本号字段，自动迁移或提示重置

User: 祭品选择是拖拽怪兽到祭坛

特殊召唤触发时机初版简化为仅己方回合触发

存档兼容在 game-core 添加版本号字段，自动迁移或提示重置

GitHub Copilot: ## Plan: 完整战斗沙盘系统（最终版）

所有设计决策已确认。实现 PC 360° 自由视角 + 手机横竖屏适配、完整召唤规则（含拖拽祭品）、地形 Buff 系统、怪兽 PK 系统、存档版本迁移。

---

### 步骤

1. **Rust 核心: 存档版本系统** — 在 gc_types.rs 添加 `GcSaveVersion { major, minor, patch }`，在存档根结构添加 `version` 字段，实现 `migrate_save(old_data, from_version, to_version)` 自动迁移函数，无法迁移时返回 `MigrationError::RequiresReset`

2. **Rust 核心: 地形系统** — 新建 `crates/game-core/src/gc_battle_terrain.rs`
   - `GcTerrainType`（Plain/Volcano/Glacier/Ocean/Swamp/Shadow）
   - `generate_terrain(world_x, world_z, enemy_id, seed)` 基于大世界地形权重 + 敌人类型修正 + 随机
   - `GcTerrainModifier { atk_percent, def_percent, hp_regen, debuff }` 地形效果结构

3. **Rust 核心: 怪兽实体** — 新建 `crates/game-core/src/gc_monster.rs`
   - `GcMonster { id, name, level, attribute, base_atk, base_def, current_hp, max_hp, position, buffs }`
   - `GcMonsterAttribute`（Fire/Water/Wind/Earth/Light/Dark）
   - `calculate_effective_stats(monster, terrain)` 返回地形加成后的实际 ATK/DEF

4. **Rust 核心: 召唤规则** — 新建 `crates/game-core/src/gc_summon.rs`
   - `GcSummonType::Normal` — 每回合限 1 次，≤4 星直接召唤
   - `GcSummonType::Tribute { sacrifices: Vec<u8> }` — 5-6 星需 1 祭品，≥7 星需 2 祭品
   - `GcSummonType::Special` — 卡牌效果触发，仅己方回合，不占普召次数
   - `validate_summon()` 返回 `Ok(())` 或 `Err(SummonError::InsufficientTributes)` 等

5. **Rust 核心: 战斗行动** — 扩展 gc_battlefield.rs
   - 南北双区域各 5 怪兽格 + 5 魔陷格
   - `attack(attacker_slot, target: Option<SlotId>)` — None 时自动选 ATK 最低目标，无怪兽则直击玩家
   - `resolve_battle(attacker, defender, terrains)` 计算伤害含地形加成

6. **WASM 接口** — 扩展 game-wasm/src/lib.rs
   - `wasm_generate_terrain()` / `wasm_normal_summon()` / `wasm_tribute_summon(sacrifices: JsValue)`
   - `wasm_monster_attack(attacker, target?)` / `wasm_get_field_state()` 返回完整 JSON
   - `wasm_check_save_version()` / `wasm_migrate_save()`

7. **设备与相机** — 修改 cl_game.ts
   - 检测 `navigator.maxTouchPoints` 区分 PC/Mobile
   - PC: `ArcRotateCamera` 无角度限制，`lowerBetaLimit = -Infinity`（允许穿地）
   - 手机: 监听 `orientationchange`，竖屏切俯视相机，横屏切侧视相机

8. **战场 3D 渲染** — 重构 cl_battle_scene.ts
   - 20 格布局（南北各 10 格：5 怪兽 + 5 魔陷）
   - 地形材质贴图：草地绿 / 火山红橙 / 冰原浅蓝 / 水域深蓝 / 沼泽棕 / 暗域紫黑
   - 性能检测: `engine.getCaps().maxTextureSize > 4096` 时启用粒子特效层

9. **怪兽占位渲染** — 新建 `client/src/render/battle/cl_monster_renderer.ts`
   - 属性→几何体映射: Fire=红胶囊 / Water=蓝立方体 / Wind=绿圆锥 / Earth=棕圆柱 / Light=黄球 / Dark=紫八面体
   - 使用 `DynamicTexture` 在头顶显示 `name + ATK/DEF`
   - 预留 `replaceWithModel(monster_id, glb_path)` 接口

10. **拖拽祭品 UI** — 修改 cl_battlefield_ui.ts
    - 添加"祭坛区域" UI 容器（屏幕中央）
    - 怪兽格支持拖拽: `onPointerDown` 开始拖拽 → 移动时显示半透明副本 → 放入祭坛区高亮
    - 祭品数量足够时显示"确认召唤"按钮
    - 触屏: 长按 500ms 启动拖拽

11. **响应式布局** — 继续修改 cl_battlefield_ui.ts
    - 竖屏: 敌方上/我方下/卡池底部/祭坛中央
    - 横屏: 敌方左/我方右/卡池右下/祭坛中央
    - 攻击目标选择: 战斗阶段点击敌方怪兽或"直接攻击"按钮

12. **战斗流程** — 修改 cl_battle_manager.ts
    - 回合阶段: Draw → Main1 → Battle → Main2 → End
    - Battle 阶段遍历己方怪兽，每只询问"自动攻击/手动选择/跳过"（可设置默认）
    - 特殊召唤仅 Main1/Main2 阶段可触发

---

### 文件清单

| 层级 | 新建文件 | 修改文件 |
|------|----------|----------|
| game-core | `gc_battle_terrain.rs` / `gc_monster.rs` / `gc_summon.rs` | `gc_battlefield.rs` / `gc_types.rs` / `lib.rs` |
| game-wasm | — | `lib.rs` |
| client/render | `cl_monster_renderer.ts` | `cl_battle_scene.ts` |
| client/ui | — | `cl_battlefield_ui.ts` / `cl_battle_ui.ts` |
| client/src | — | `cl_game.ts` / `cl_battle_manager.ts` |

---

### 实施阶段

| 阶段 | 交付内容 | 工期 |
|------|----------|------|
| **P1** | 存档版本 + 地形系统 + 战场南北布局 | 2天 |
| **P2** | 怪兽实体 + 占位几何体 + 召唤规则 | 3天 |
| **P3** | 拖拽祭品 UI + 战斗流程 | 3天 |
| **P4** | PC 360° + 手机横竖屏适配 | 2天 |
| **P5** | 地形特效 + 性能开关 + 打磨 | 1天 |

---

计划已完整，是否进入实施阶段？

User: Start implementation

GitHub Copilot: 已创建 10 个待办事项
# æ€§èƒ½ä¼˜åŒ–æ¶æ„æ–‡æ¡£

> **é•¿æœŸä¸»ä¹‰å¼€å‘æŒ‡å—** - PCç«¯3Açº§æ¸¸æˆä¼˜åŒ–

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰çŠ¶æ€ |
|------|--------|---------|
| å¸§ç‡ (FPS) | 60+ | âœ… ç¨³å®š60+ |
| Draw Call | < 100 | âœ… çº¦20ä¸ª |
| æ ‘æœ¨æ•°é‡ | 1000+ | âœ… æ”¯æŒ300æ£µ |
| ç«¹å­æ•°é‡ | 2000+ | âœ… æ”¯æŒ400æ ¹ |
| å†…å­˜å ç”¨ | < 500MB | âœ… çº¦200MB |

---

## ğŸ“ å·²å®ç°çš„ä¼˜åŒ–æŠ€æœ¯

### **ç¬¬1é˜¶æ®µ: å®ä¾‹åŒ–æ¸²æŸ“ (Instancing)** âœ…

**åŸç†:**
- å°†ç›¸åŒçš„æ¨¡å‹æ•°æ®ä¸Šä¼ ä¸€æ¬¡åˆ°GPU
- é€šè¿‡å˜æ¢çŸ©é˜µ (Transform Matrix) æ‰¹é‡æ¸²æŸ“å¤šä¸ªå®ä¾‹
- 1ä¸ªDraw Callå¯ä»¥æ¸²æŸ“1000+ä¸ªç‰©ä½“

**ä»£ç å®ç°:**
```typescript
// åˆ›å»ºæ¨¡æ¿
const template = MeshBuilder.CreateCylinder('trunk', {...}, scene);

// ç”Ÿæˆä½ç½®çŸ©é˜µ
const matrices: number[] = [];
for (let i = 0; i < 1000; i++) {
    const matrix = Matrix.Translation(x, y, z);
    matrices.push(...matrix.asArray());
}

// æ‰¹é‡æ¸²æŸ“
template.thinInstanceSetBuffer('matrix', new Float32Array(matrices), 16);
```

**æ•ˆæœå¯¹æ¯”:**
- âŒ æ—§æ–¹æ¡ˆ: 300æ£µæ ‘ = 600ä¸ªDraw Call (å¡é¡¿)
- âœ… æ–°æ–¹æ¡ˆ: 300æ£µæ ‘ = 2ä¸ªDraw Call (æµç•…)

---

### **ç¬¬2é˜¶æ®µ: LODç³»ç»Ÿ (Level of Detail)** âœ…

**åŸç†:**
- è¿‘è·ç¦»: ä½¿ç”¨é«˜é¢æ•°æ¨¡å‹ (é«˜ç²¾åº¦)
- ä¸­è·ç¦»: ä½¿ç”¨ä¸­é¢æ•°æ¨¡å‹ (ä¸­ç²¾åº¦)
- è¿œè·ç¦»: ä½¿ç”¨ä½é¢æ•°æ¨¡å‹ (ä½ç²¾åº¦)
- è¶…è¿œè·ç¦»: ä¸æ¸²æŸ“ (å‰”é™¤)

**ä»£ç å®ç°:**
```typescript
// åˆ›å»º3ä¸ªLODçº§åˆ«
const trunkHigh = MeshBuilder.CreateCylinder('high', { tessellation: 16 }, scene);
const trunkMid = MeshBuilder.CreateCylinder('mid', { tessellation: 8 }, scene);
const trunkLow = MeshBuilder.CreateCylinder('low', { tessellation: 4 }, scene);

// é…ç½®LODåˆ‡æ¢è·ç¦»
trunkHigh.addLODLevel(30, trunkMid);   // 30ç±³å¤–åˆ‡æ¢åˆ°ä¸­ç²¾åº¦
trunkHigh.addLODLevel(80, trunkLow);   // 80ç±³å¤–åˆ‡æ¢åˆ°ä½ç²¾åº¦
trunkHigh.addLODLevel(150, null);      // 150ç±³å¤–ä¸æ¸²æŸ“
```

**LODçº§åˆ«è®¾è®¡:**

| ç‰©ä½“ | LOD 0 (è¿‘) | LOD 1 (ä¸­) | LOD 2 (è¿œ) | å‰”é™¤è·ç¦» |
|------|-----------|-----------|-----------|---------|
| æ ‘å¹² | 16é¢ | 8é¢ | 4é¢ | 150ç±³ |
| æ ‘å¶ | 16é¢çƒ | 8é¢çƒ | 4é¢çƒ | 150ç±³ |
| ç«¹å­ | 12é¢ | 4é¢ | - | 100ç±³ |
| å»ºç­‘ | é«˜æ¨¡ | ä¸­æ¨¡ | ä½æ¨¡ | 200ç±³ |

**æ€§èƒ½æå‡:**
- GPUè´Ÿè½½: é™ä½50-70%
- å¯è§ç‰©ä½“æ•°é‡: å¢åŠ 3å€
- å¸§ç‡: æå‡20-40 FPS

---

## ğŸ”® æœªæ¥ä¼˜åŒ–è®¡åˆ’

### **ç¬¬3é˜¶æ®µ: è§†é”¥å‰”é™¤ (Frustum Culling)** ğŸ”„

**åŸç†:**
- åªæ¸²æŸ“æ‘„åƒæœºè§†é‡å†…çš„ç‰©ä½“
- è§†é‡å¤–çš„ç‰©ä½“ç›´æ¥è·³è¿‡æ¸²æŸ“

**å®ç°æ–¹æ¡ˆ:**
```typescript
scene.onBeforeRenderObservable.add(() => {
    const frustumPlanes = camera.frustumPlanes;
    
    for (const mesh of scene.meshes) {
        mesh.isVisible = mesh.isInFrustum(frustumPlanes);
    }
});
```

**é¢„æœŸæ•ˆæœ:**
- GPUè´Ÿè½½: å†é™ä½30-50%
- æ”¯æŒç‰©ä½“æ•°é‡: å¯è¾¾10000+

---

### **ç¬¬4é˜¶æ®µ: Octree ç©ºé—´åˆ†å‰²** ğŸ”„

**åŸç†:**
- å°†åœºæ™¯åˆ’åˆ†ä¸º8å‰æ ‘ç»“æ„
- å¿«é€ŸæŸ¥è¯¢ç‰¹å®šåŒºåŸŸå†…çš„ç‰©ä½“
- æ”¯æŒåŠ¨æ€ç‰©ä½“ç®¡ç†

**å®ç°æ–¹æ¡ˆ:**
```typescript
const octree = scene.createOrUpdateSelectionOctree();
octree.dynamicContent.push(...dynamicMeshes);

// å¿«é€ŸåŒºåŸŸæŸ¥è¯¢
const objectsInRegion = octree.intersects(boundingBox);
```

**é¢„æœŸæ•ˆæœ:**
- ç¢°æ’æ£€æµ‹é€Ÿåº¦: æå‡100å€
- AIå¯»è·¯æ€§èƒ½: æå‡50å€
- æ”¯æŒç‰©ä½“æ•°é‡: å¯è¾¾100000+

---

### **ç¬¬5é˜¶æ®µ: GPU Instancing + æ‰¹å¤„ç†** ğŸ”„

**åŸç†:**
- ä½¿ç”¨GPUç¡¬ä»¶å®ä¾‹åŒ–
- åˆå¹¶æè´¨ç›¸åŒçš„ç‰©ä½“
- å‡å°‘çŠ¶æ€åˆ‡æ¢

**å®ç°æ–¹æ¡ˆ:**
```typescript
// å¯ç”¨GPUå®ä¾‹åŒ–
mesh.registerInstancedBuffer('color', 4);
mesh.instancedBuffers.color = new Color4(r, g, b, a);

// æè´¨æ‰¹å¤„ç†
scene.freezeActiveMeshes();
scene.autoClear = false;
```

**é¢„æœŸæ•ˆæœ:**
- Draw Call: é™è‡³10ä¸ªä»¥ä¸‹
- æ”¯æŒç‰©ä½“æ•°é‡: å¯è¾¾1000000+

---

## ğŸ“Š æ€§èƒ½ç›‘æ§

### **å†…ç½®æ€§èƒ½ç»Ÿè®¡**
```typescript
// å¼€å¯FPSæ˜¾ç¤º
scene.debugLayer.show({ embedMode: true });

// è·å–ç»Ÿè®¡æ•°æ®
const fps = engine.getFps();
const drawCalls = scene.getActiveMeshes().length;
const triangleCount = scene.getTotalVertices();

console.log(`FPS: ${fps} | Draw Calls: ${drawCalls} | Triangles: ${triangleCount}`);
```

### **æ¨èå·¥å…·**
- **Chrome DevTools Performance**: CPU/GPUæ€§èƒ½åˆ†æ
- **Babylon.js Inspector**: å®æ—¶åœºæ™¯è°ƒè¯•
- **Stats.js**: è½»é‡çº§FPSç›‘æ§
- **RenderDoc**: ä¸“ä¸šå›¾å½¢è°ƒè¯•å·¥å…·

---

## ğŸ“ æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•
1. **ä¼˜å…ˆä½¿ç”¨å®ä¾‹åŒ–æ¸²æŸ“** - ç›¸åŒç‰©ä½“å¿…é¡»ç”¨Instancing
2. **ä¸ºæ‰€æœ‰ç‰©ä½“é…ç½®LOD** - æ ¹æ®é‡è¦æ€§è®¾ç½®ä¸åŒçº§åˆ«
3. **åˆç†è®¾ç½®å‰”é™¤è·ç¦»** - ä¸é‡è¦çš„ç‰©ä½“å°½æ—©å‰”é™¤
4. **å¤ç”¨æè´¨** - ç›¸åŒæè´¨çš„ç‰©ä½“å…±äº«Materialå¯¹è±¡
5. **é¿å…å®æ—¶é˜´å½±** - é™æ€ç‰©ä½“ä½¿ç”¨é¢„çƒ˜ç„™é˜´å½±

### âŒ ç¦æ­¢åšæ³•
1. **forå¾ªç¯åˆ›å»ºç‹¬ç«‹Mesh** - å¿…é¡»ç”¨Instancingæ›¿ä»£
2. **æ‰€æœ‰ç‰©ä½“éƒ½æŠ•å°„é˜´å½±** - åªç»™é‡è¦ç‰©ä½“åŠ é˜´å½±
3. **ä½¿ç”¨4Kè´´å›¾åœ¨ç§»åŠ¨ç«¯** - æ ¹æ®å¹³å°é€‰æ‹©åˆé€‚åˆ†è¾¨ç‡
4. **æ¯å¸§æ›´æ–°æ‰€æœ‰ç‰©ä½“** - ä½¿ç”¨è„æ ‡è®° (Dirty Flag) ä¼˜åŒ–
5. **å¿½ç•¥å†…å­˜ç®¡ç†** - åŠæ—¶disposeä¸ç”¨çš„èµ„æº

---

## ğŸ”§ è°ƒè¯•æŠ€å·§

### **å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆ**
```typescript
// 1. æŸ¥çœ‹Draw Callæ•°é‡
console.log('Draw Calls:', scene.getActiveMeshes().length);

// 2. æŸ¥çœ‹ä¸‰è§’å½¢æ•°é‡
console.log('Triangles:', scene.getTotalVertices() / 3);

// 3. æŸ¥çœ‹æè´¨æ•°é‡
console.log('Materials:', scene.materials.length);

// 4. æŸ¥çœ‹çº¹ç†æ•°é‡å’Œå¤§å°
scene.textures.forEach(tex => {
    console.log(`${tex.name}: ${tex.getSize().width}x${tex.getSize().height}`);
});
```

### **æ€§èƒ½åŸºå‡†æµ‹è¯•**
```typescript
const startTime = performance.now();

// æ‰§è¡Œæ“ä½œ
for (let i = 0; i < 1000; i++) {
    scene.render();
}

const endTime = performance.now();
console.log(`å¹³å‡å¸§æ—¶é—´: ${(endTime - startTime) / 1000}ms`);
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Babylon.js æ€§èƒ½ä¼˜åŒ–æŒ‡å—](https://doc.babylonjs.com/features/performance)
- [GPU Gems 3 - LODæŠ€æœ¯](https://developer.nvidia.com/gpugems/gpugems3)
- [Real-Time Rendering 4th Edition](http://www.realtimerendering.com/)
- [Game Engine Architecture](https://www.gameenginebook.com/)

---

**æœ€åæ›´æ–°:** 2025å¹´12æœˆ22æ—¥  
**ç»´æŠ¤è€…:** AIå¼€å‘åŠ©æ‰‹  
**çŠ¶æ€:** æŒç»­ä¼˜åŒ–ä¸­ ğŸš€
